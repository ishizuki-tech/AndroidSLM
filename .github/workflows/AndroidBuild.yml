# .github/workflows/AndroidBuild.yml
# ============================================================
# üöÄ AndroidSLM ‚Äî Build + Release + Wiki + Pages (Always Debug Signing)
# ============================================================

name: AndroidSLM ‚Äî Build+Release+Wiki+Pages (Debug-Signed)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      force_build:
        description: "Force rebuild regardless of diff detection"
        type: boolean
        default: false
      version_tag:
        description: "Release tag (empty = auto; tag push = use pushed tag)"
        required: false
        type: string
      prerelease:
        description: "Mark GitHub Release as prerelease"
        required: false
        default: true
        type: boolean
      build_type:
        description: "Variant (auto = release (debug-signed))"
        required: false
        default: "auto"
        type: choice
        options: [auto, release, debug]

permissions:
  contents: write
  pages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  OWNER: ${{ github.repository_owner }}
  REPO: ${{ github.repository }}     # e.g., ishizuki-tech/AndroidSLM
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_VERSION: "17"
  NDK_VERSION: 28.1.13356709
  _JAVA_OPTIONS: "-Xmx4g"
  GRADLE_OPTS: "-Xmx4g -Dorg.gradle.daemon=true"

jobs:
  # ============================================================
  # üß† Smart Detect
  # ============================================================
  detect:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: detect
        run: |
          set -Eeuo pipefail
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"; exit 0
          fi
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"; exit 0
          fi
          CHANGED=$(git diff --name-only "$LAST_TAG" HEAD | grep -E '^(app/|nativelib/|gradle/|.*\.(kt|kts|cpp|hpp|h|yaml|yml))' || true)
          if [ -n "$CHANGED" ]; then echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi

  # ============================================================
  # üèóÔ∏è Build + GitHub Release (Always Debug-Signed)
  # ============================================================
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' || inputs.force_build == true || startsWith(github.ref, 'refs/tags/') }}
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      variant: ${{ steps.build.outputs.variant }}
      signing: ${{ steps.build.outputs.signing }}
    steps:
      - name: üß∞ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: üîí Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v3

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: gradle

      - name: üß± Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: üõ†Ô∏è Setup Android (sdk/ndk)
        uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: üìú Accept Android SDK licenses (best-effort)
        run: |
          set -e
          SDKMANAGER="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager"
          if [ -x "$SDKMANAGER" ]; then yes | "$SDKMANAGER" --licenses || true; fi

      - name: üßæ Ensure gradlew is executable
        run: chmod +x ./gradlew

      - name: üß™ Lint & Unit tests (optional)
        if: ${{ inputs.enable_review == true || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) }}
        run: |
          ./gradlew --console=plain --info --stacktrace --no-daemon lintDebug testDebugUnitTest || \
            echo "::warning::Lint/Tests failed (continuing)"

      - name: üèóÔ∏è Build (release is debug-signed) + Diagnostics
        id: build
        run: |
          set -e
          VARIANT="${{ inputs.build_type }}"
          if [ "$VARIANT" = "auto" ]; then VARIANT="release"; fi   # Â∏∏„Å´ release „ÇíÂÑ™ÂÖàÔºà‰∏≠Ë∫´„ÅØ debug ÁΩ≤ÂêçÔºâ
          echo "Chosen variant: $VARIANT (signing=debug)"

          export _JAVA_OPTIONS="-Xmx4g"
          export GRADLE_OPTS="-Xmx4g -Dorg.gradle.daemon=false"

          # ‚Äª app/build.gradle.kts ÂÅ¥„Åß„Äårelease = signingConfigs.debug„Äç„Å´„Åó„Å¶„ÅÇ„Çã„Åì„Å®„ÅåÂâçÊèê
          set +e
          if [ "$VARIANT" = "release" ]; then
            ./gradlew --console=plain --info --stacktrace :app:clean :app:assembleRelease :app:bundleRelease
            STATUS=$?
            APK_PATH="app/build/outputs/apk/release/app-release.apk"
            AAB_PATH="app/build/outputs/bundle/release/app-release.aab"
            MAP_PATH="app/build/outputs/mapping/release/mapping.txt"
          else
            ./gradlew --console=plain --info --stacktrace :app:clean :app:assembleDebug
            STATUS=$?
            APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
            AAB_PATH=""
            MAP_PATH=""
          fi
          set -e

          if [ $STATUS -ne 0 ]; then
            echo "‚ùå Gradle build failed. Dumping daemon/Kotlin logs..."
            mkdir -p diag
            (ls -la ~/.gradle/daemon || true) > diag/gradle-daemon-ls.txt
            (find ~/.gradle -type f -name "*.log" -maxdepth 3 -print -exec tail -n 200 {} \; || true) > diag/gradle-logs-tail.txt
            (find . -type f -path "*/kotlin/*" -name "*.log" -print -exec tail -n 200 {} \; || true) > diag/kotlin-logs-tail.txt
            echo "::group::Gradle/Kotlin logs tail"
            tail -n 400 diag/gradle-logs-tail.txt || true
            tail -n 400 diag/kotlin-logs-tail.txt || true
            echo "::endgroup::"
            exit $STATUS
          fi

          test -f "$APK_PATH" || (echo "::error::APK missing: $APK_PATH" && exit 3)
          echo "apk=$APK_PATH" >> $GITHUB_OUTPUT
          if [ -n "$AAB_PATH" ] && [ -f "$AAB_PATH" ]; then echo "aab=$AAB_PATH" >> $GITHUB_OUTPUT; fi
          if [ -n "$MAP_PATH" ] && [ -f "$MAP_PATH" ]; then echo "mapping=$MAP_PATH" >> $GITHUB_OUTPUT; fi
          echo "variant=$VARIANT" >> $GITHUB_OUTPUT
          echo "signing=debug" >> $GITHUB_OUTPUT
          echo "::notice::Build success ‚Üí variant=$VARIANT, signing=debug, APK=$(basename "$APK_PATH"), AAB=$(basename "$AAB_PATH" 2>/dev/null || echo '-')"

      - name: üè∑Ô∏è Derive version tag
        id: tag
        run: |
          set -e
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF##*/}"
          elif [ -n "${{ inputs.version_tag }}" ]; then
            TAG="${{ inputs.version_tag }}"
          else
            if grep -q 'versionName' app/build.gradle.kts; then
              VERSION=$(grep -E 'versionName\s*=\s*"([^"]+)"' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1)
            else
              VERSION="0.0.0"
            fi
            SHA=$(git rev-parse --short HEAD)
            TAG="v${VERSION}-${SHA}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: üì∞ Release notes (debug signing)
        id: notes
        run: |
          set -e
          VARIANT="${{ steps.build.outputs.variant }}"
          APK="${{ steps.build.outputs.apk }}"
          AAB="${{ steps.build.outputs.aab }}"
          MAP="${{ steps.build.outputs.mapping }}"
          {
            echo "## AndroidSLM ‚Äî $VARIANT build"
            echo ""
            echo "- Tag: \`${{ steps.tag.outputs.tag }}\`"
            echo "- Commit: \`${GITHUB_SHA}\`"
            echo "- Signing: \`debug\` (release variant is debug-signed)"
            echo "- APK: \`$(basename "$APK")\`"
            if [ -n "$AAB" ]; then echo "- AAB: \`$(basename "$AAB")\`"; fi
            if [ -n "$MAP" ]; then echo "- ProGuard mapping: \`$(basename "$MAP")\`"; fi
            echo ""
            echo "> ‚ö†Ô∏è This build is signed with the DEBUG keystore."
            echo "> Not suitable for Play upload; for internal distribution/testing."
          } > RELEASE_NOTES.md
          cat RELEASE_NOTES.md

      - name: üèÅ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: AndroidSLM ${{ steps.tag.outputs.tag }}
          body_path: RELEASE_NOTES.md
          prerelease: ${{ inputs.prerelease }}
          draft: false
          files: |
            ${{ steps.build.outputs.apk }}
            ${{ steps.build.outputs.aab }}
            ${{ steps.build.outputs.mapping }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # üöÄ Publish Wiki + GH Pages (No Model sections)
  # ============================================================
  publish:
    name: Publish Wiki + Pages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build, detect]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üßÆ Resolve TAG/DATE/URLs
        id: info
        run: |
          set -e
          TAG="${{ needs.build.outputs.tag }}"
          if [ -z "$TAG" ]; then
            if [[ "${GITHUB_REF}" == refs/tags/* ]]; then TAG="${GITHUB_REF##*/}"; else TAG="no-build-$(date '+%Y%m%d-%H%M')"; fi
          fi
          DATE="$(date '+%Y-%m-%d %H:%M')"
          REPO="${{ env.REPO }}"
          OWNER="${{ env.OWNER }}"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO_NAME}"
          echo "tag=$TAG"   >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "base=$BASE_URL" >> $GITHUB_OUTPUT

      - name: üåà Generate Wiki (Home + Build page)
        run: |
          set -e
          TAG="${{ steps.info.outputs.tag }}"
          DATE="${{ steps.info.outputs.date }}"
          REPO="${{ steps.info.outputs.repo }}"
          BASE_URL="${{ steps.info.outputs.base }}"
          mkdir -p wiki/Builds

          # ---------- Individual build page ----------
          {
            echo "# üì¶ AndroidSLM ‚Äî Build ${TAG}"
            echo "Generated: ${DATE}"
            echo ""
            echo "## ‚¨áÔ∏è Download"
            echo "- [APK (latest release)](https://github.com/${REPO}/releases/latest/download/app-release.apk)"
            echo "- [Releases](https://github.com/${REPO}/releases)"
            echo ""
            echo "> Signing: debug (release variant is debug-signed)"
          } > "wiki/Builds/${TAG}.md"

          # ---------- Wiki Home ----------
          {
            echo "# üè† AndroidSLM Wiki Home"
            echo "Updated: ${DATE}"
            echo ""
            echo "## üìú Build History (latest 20)"
          } > wiki/Home.md

          MAP_TMP="wiki/_link-map.txt"; : > "$MAP_TMP"
          LIST=$(find wiki/Builds -type f -name '*.md' | sort -r | head -n 20 || true)

          if [ -z "$LIST" ]; then
            echo "_No builds yet._" >> wiki/Home.md
          else
            echo "$LIST" | while read -r f; do
              rel="${f#wiki/}"                # ‚Üí "Builds/v1.0-xxx.md"
              name="${rel%.md}"              # ‚Üí "Builds/v1.0-xxx"
              slug="$(printf '%s' "$name" | sed -E 's@[[:space:]]+@-@g; s@/@-@g; s/-+/-/g')"  # ‚Üí "Builds-v1.0-xxx"
              printf -- "- [%s](https://github.com/%s/wiki/%s)\n" "$name" "$REPO" "$slug" >> wiki/Home.md
              printf -- "%s -> %s\n" "$name" "$slug" >> "$MAP_TMP"
            done
          fi

          echo "" >> wiki/Home.md
          {
            echo "## üåê GH Pages"
            echo "- [Downloads Page](${BASE_URL})"
            echo ""
            echo "## üì± QR (GH Pages)"
            echo "<p align='center'><img src='https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${BASE_URL}' width='180'></p>"
          } >> wiki/Home.md

          echo "::group::Wiki tree"; ls -R wiki || true; echo "::endgroup::"
          echo "::group::Wiki link map (original -> slug)"; cat "$MAP_TMP" || true; echo "::endgroup::"

          cd wiki
          git init
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          if git diff --cached --quiet; then
            git commit --allow-empty -m "üì¶ Ensure master branch exists"
          else
            git commit -m "üè† Update Wiki ${TAG}"
          fi
          git branch -M master
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.wiki.git"
          git push origin master --force

      - name: üíé Generate GH Pages (Glass UI)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # ------- Inputs from previous step (publish/info) -------
          TAG_THIS="${{ steps.info.outputs.tag }}"
          DATE="${{ steps.info.outputs.date }}"
          REPO="${{ steps.info.outputs.repo }}"
          BASE_URL="${{ steps.info.outputs.base }}"

          # ------- Optional: current build info (ÈùûÂøÖÈ†à) -------
          VARIANT="${{ needs.build.outputs.variant }}"
          SIGNING="${{ needs.build.outputs.signing }}"
          APK_NAME_THIS="${{ needs.build.outputs.apk_name }}"
          AAB_NAME_THIS="${{ needs.build.outputs.aab_name }}"

          # ------- Require jq -------
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y >/dev/null
            sudo apt-get install -y jq >/dev/null
          fi

          # ------- Fetch latest (including prerelease, excluding drafts) -------
          curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/repos/${REPO}/releases?per_page=10" \
               -o releases.json

          # ÊúÄÊñ∞„ÅÆ„Äådraft=false„Äç„Çí1‰ª∂ÊäΩÂá∫
          jq -e '[ .[] | select(.draft==false) ][0]' releases.json >/dev/null || {
            echo "::warning::No non-draft releases found. Falling back to Releases page."
            LATEST_TAG=""
            LATEST_APK_NAME=""
          }

          if [ -z "${LATEST_TAG:-}" ]; then
            LATEST_TAG=$(jq -r '[ .[] | select(.draft==false) ][0].tag_name // empty' releases.json)
          fi

          # „Åù„ÅÆ„É™„É™„Éº„Çπ„ÅÆ APK ÂÄôË£ú‰∏ÄË¶ßÔºàÂêçÂâçÔºâ
          APK_LIST=$(jq -r '[ .[] | select(.draft==false) ][0].assets[]?.name // empty' releases.json | tr -d '\r')
          LATEST_APK_NAME=""
          if [ -n "$APK_LIST" ]; then
            # ÂÑ™ÂÖàÂ∫¶: app-release.apk > /release.*\.apk/i > ‰ªªÊÑè„ÅÆ *.apk
            if echo "$APK_LIST" | grep -Fxq 'app-release.apk'; then
              LATEST_APK_NAME='app-release.apk'
            elif echo "$APK_LIST" | grep -Eqi 'release.*\.apk$'; then
              LATEST_APK_NAME=$(echo "$APK_LIST" | grep -Ei 'release.*\.apk$' | head -n1)
            elif echo "$APK_LIST" | grep -Eq '\.apk$'; then
              LATEST_APK_NAME=$(echo "$APK_LIST" | grep -E '\.apk$' | head -n1)
            fi
          fi

          # URL ÁµÑ„ÅøÁ´ã„Å¶ÔºàË¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞ Releases „Å∏„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
          if [ -n "${LATEST_TAG}" ] && [ -n "${LATEST_APK_NAME}" ]; then
            APK_URL="https://github.com/${REPO}/releases/download/${LATEST_TAG}/${LATEST_APK_NAME}"
          else
            APK_URL="https://github.com/${REPO}/releases"
          fi

          # AAB „ÇÇ„ÅÇ„Çå„Å∞ÂêåÊßò„Å´Ôºà‰ªªÊÑèÔºâ
          LATEST_AAB_NAME=""
          if [ -n "$APK_LIST" ]; then
            if echo "$APK_LIST" | grep -Eq '\.aab$'; then
              LATEST_AAB_NAME=$(echo "$APK_LIST" | grep -E '\.aab$' | head -n1)
            fi
          fi
          if [ -n "${LATEST_TAG}" ] && [ -n "${LATEST_AAB_NAME}" ]; then
            AAB_URL="https://github.com/${REPO}/releases/download/${LATEST_TAG}/${LATEST_AAB_NAME}"
          else
            AAB_URL=""
          fi

          echo "::group::Resolved latest release asset"
          echo "LATEST_TAG      : ${LATEST_TAG:-'(none)'}"
          echo "LATEST_APK_NAME : ${LATEST_APK_NAME:-'(none)'}"
          echo "LATEST_AAB_NAME : ${LATEST_AAB_NAME:-'(none)'}"
          echo "APK_URL         : ${APK_URL}"
          if [ -n "${AAB_URL}" ]; then echo "AAB_URL         : ${AAB_URL}"; fi
          echo "::endgroup::"

          # ------- Render GH Pages (Glass UI) -------
          mkdir -p gh-pages
          cat > gh-pages/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"/>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>üì¶ AndroidSLM Downloads</title>
          <style>
            body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,'Helvetica Neue',Arial;background:#0b0f17;color:#eee;margin:0}
            .wrap{max-width:960px;margin:auto;padding:40px}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;
                   box-shadow:0 8px 40px rgba(0,0,0,0.4);
                   padding:32px;backdrop-filter:blur(14px)}
            a{color:#72d0ff;text-decoration:none}
            footer{margin-top:24px;font-size:.85em;opacity:.7;text-align:center}
            .muted{opacity:.8}
            .row a{display:inline-block;margin-right:10px}
            code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
          </style>
          </head>
          <body><div class="wrap"><div class="glass">
          <p><a href="index.html" target=_self title="Separate Page">Go to index</a></p>
          <h1>üì¶ AndroidSLM ‚Äî Latest Download</h1>
          <p class="muted"><strong>Generated:</strong> ${DATE}</p>

          <h2>‚¨áÔ∏è Latest Release</h2>
          <p class="row">
            <a href="${APK_URL}">APK ${LATEST_APK_NAME:+(<code>${LATEST_APK_NAME}</code>)}</a>
            ${AAB_URL:+<a href="${AAB_URL}">AAB (<code>${LATEST_AAB_NAME}</code>)</a>}
          </p>
          <p>
            ${LATEST_TAG:+<a href="https://github.com/${REPO}/releases/tag/${LATEST_TAG}">üîñ ${LATEST_TAG}</a> ‚Ä¢ }
            <a href="https://github.com/${REPO}/releases">üìò All Releases</a>
          </p>

          <hr style="border-color:rgba(255,255,255,.15);margin:24px 0">

          <h2>üß™ This Build (for reference)</h2>
          <p class="muted">
            <strong>Tag:</strong> ${TAG_THIS} ‚Ä¢ <strong>Variant:</strong> ${VARIANT:-n/a} ‚Ä¢ <strong>Signing:</strong> ${SIGNING:-n/a}
          </p>
          <p class="row">
            ${APK_NAME_THIS:+<a href="https://github.com/${REPO}/releases/download/${TAG_THIS}/${APK_NAME_THIS}">This build APK (<code>${APK_NAME_THIS}</code>)</a>}
            ${AAB_NAME_THIS:+<a href="https://github.com/${REPO}/releases/download/${TAG_THIS}/${AAB_NAME_THIS}">This build AAB (<code>${AAB_NAME_THIS}</code>)</a>}
          </p>

          <p style="margin-top:16px;">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" alt="QR">
          </p>
          <footer>Generated by AndroidSLM CI ‚Ä¢ ${DATE}</footer>
          </div></div></body></html>
          HTML

      - name: üöÄ Publish GH Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "üåà Update GH Pages + Wiki (${{steps.info.outputs.tag}})"
