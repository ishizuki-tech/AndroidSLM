# ============================================================
# ğŸš€ AndroidSLM â€” Build + Release + Wiki + Pages (Always Debug Signing)
# ============================================================

name: AndroidSLM â€” Build+Release+Wiki+Pages (Debug-Signed)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      force_build:
        description: "Force rebuild regardless of diff detection"
        type: boolean
        default: false
      version_tag:
        description: "Release tag (empty = auto; tag push = use pushed tag)"
        required: false
        type: string
      prerelease:
        description: "Mark GitHub Release as prerelease"
        required: false
        default: true
        type: boolean
      build_type:
        description: "Variant (auto = release (debug-signed))"
        required: false
        default: "auto"
        type: choice
        options: [auto, release, debug]

permissions:
  contents: write
  pages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  OWNER: ${{ github.repository_owner }}
  REPO: ${{ github.repository }}
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_VERSION: "17"
  NDK_VERSION: 28.1.13356709
  _JAVA_OPTIONS: "-Xmx4g"
  GRADLE_OPTS: "-Xmx4g -Dorg.gradle.daemon=true"

# ============================================================
# ğŸ§  Job: Detect / Build / Publish
# ============================================================

jobs:
  detect:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: detect
        run: |
          set -Eeuo pipefail
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"; exit 0
          fi
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"; exit 0
          fi
          CHANGED=$(git diff --name-only "$LAST_TAG" HEAD | grep -E '^(app/|nativelib/|gradle/|.*\.(kt|kts|cpp|hpp|h|yaml|yml))' || true)
          if [ -n "$CHANGED" ]; then echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi

  # ============================================================
  # ğŸ—ï¸ Build + GitHub Release (Always Debug-Signed)
  # ============================================================
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' || inputs.force_build == true || startsWith(github.ref, 'refs/tags/') }}
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      variant: ${{ steps.build.outputs.variant }}
      signing: ${{ steps.build.outputs.signing }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: gradle

      - name: ğŸ§± Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ› ï¸ Setup Android (sdk/ndk)
        uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: ğŸ“œ Accept SDK Licenses
        run: yes | "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --licenses || true

      - name: ğŸ§ª Lint & Unit tests (optional)
        if: ${{ inputs.enable_review == true || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) }}
        run: |
          ./gradlew lintDebug testDebugUnitTest || echo "::warning::Lint/Tests failed (continuing)"

      - name: ğŸ—ï¸ Build (release variant debug-signed)
        id: build
        run: |
          set -e
          VARIANT="${{ inputs.build_type }}"
          [ "$VARIANT" = "auto" ] && VARIANT="release"
          echo "variant=$VARIANT" >> $GITHUB_OUTPUT
          ./gradlew :app:clean :app:assembleRelease :app:bundleRelease --stacktrace
          echo "signing=debug" >> $GITHUB_OUTPUT
          echo "apk=app/build/outputs/apk/release/app-release.apk" >> $GITHUB_OUTPUT
          echo "aab=app/build/outputs/bundle/release/app-release.aab" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Derive version tag
        id: tag
        run: |
          set -e
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF##*/}"
          else
            VERSION=$(grep -E 'versionName\s*=\s*"([^"]+)"' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1)
            SHA=$(git rev-parse --short HEAD)
            TAG="v${VERSION}-${SHA}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: â™»ï¸ Normalize filenames
        id: alias
        run: |
          set -e
          TAG="${{ steps.tag.outputs.tag }}"
          mkdir -p publish
          cp app/build/outputs/apk/release/app-release.apk "publish/AndroidSLM-${TAG}.apk"
          cp app/build/outputs/apk/release/app-release.apk "publish/AndroidSLM-latest.apk"
          echo "apk_tag=publish/AndroidSLM-${TAG}.apk" >> $GITHUB_OUTPUT
          echo "apk_latest=publish/AndroidSLM-latest.apk" >> $GITHUB_OUTPUT

      - name: ğŸ“° Release Notes
        run: |
          {
            echo "## AndroidSLM â€” release build"
            echo "- Tag: ${{ steps.tag.outputs.tag }}"
            echo "- Signing: debug"
            echo "- APK: AndroidSLM-${{ steps.tag.outputs.tag }}.apk"
          } > RELEASE_NOTES.md

      - name: ğŸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: AndroidSLM ${{ steps.tag.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: |
            ${{ steps.alias.outputs.apk_tag }}
            ${{ steps.alias.outputs.apk_latest }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # ğŸš€ Publish Wiki + GH Pages
  # ============================================================
  publish:
    name: Publish Wiki + Pages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§® Resolve TAG/DATE
        id: info
        run: |
          TAG="${{ needs.build.outputs.tag }}"
          DATE="$(date '+%Y-%m-%d %H:%M')"
          REPO="${{ env.REPO }}"
          BASE_URL="https://${{ env.OWNER }}.github.io/${REPO#*/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "base=$BASE_URL" >> $GITHUB_OUTPUT

      - name: ğŸŒˆ Generate Wiki (auto-detect release assets)
        run: |
          set -e
          TAG="${{ steps.info.outputs.tag }}"
          REPO="${{ steps.info.outputs.repo }}"
          DATE="${{ steps.info.outputs.date }}"

          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          # æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ tag ã¨ APK åã‚’å–å¾—
          curl -fsSL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases?per_page=5" -o releases.json

          LATEST_TAG=$(jq -r '[.[] | select(.draft==false)][0].tag_name' releases.json)
          LATEST_APK=$(jq -r '[.[] | select(.draft==false)][0].assets[]?.name | select(test("\\.apk$"))' releases.json | head -n1)

          if [ -n "$LATEST_TAG" ] && [ -n "$LATEST_APK" ]; then
            LATEST_APK_URL="https://github.com/${REPO}/releases/download/${LATEST_TAG}/${LATEST_APK}"
          else
            LATEST_APK_URL="https://github.com/${REPO}/releases"
          fi

          mkdir -p wiki
          {
            echo "# ğŸ“¦ AndroidSLM â€” Build ${TAG}"
            echo "Generated: ${DATE}"
            echo ""
            echo "## â¬‡ï¸ Download"
            echo "- [Latest APK](${LATEST_APK_URL})"
            echo "- [This tag APK](https://github.com/${REPO}/releases/download/${TAG}/AndroidSLM-${TAG}.apk)"
            echo "- [All Releases](https://github.com/${REPO}/releases)"
          } > "wiki/${TAG}.md"

      - name: ğŸ’ Generate GH Pages (Glass UI)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ steps.info.outputs.tag }}"
          DATE="${{ steps.info.outputs.date }}"
          REPO="${{ steps.info.outputs.repo }}"
          BASE_URL="${{ steps.info.outputs.base }}"

          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          # æœ€æ–°APKæ¤œå‡º
          curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases?per_page=5" -o releases.json

          LATEST_TAG=$(jq -r '[.[] | select(.draft==false)][0].tag_name' releases.json)
          LATEST_APK=$(jq -r '[.[] | select(.draft==false)][0].assets[]?.name | select(test("\\.apk$"))' releases.json | head -n1)
          LATEST_APK_URL="https://github.com/${REPO}/releases/download/${LATEST_TAG}/${LATEST_APK}"

          mkdir -p gh-pages
          cat > gh-pages/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"/>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>ğŸ“¦ AndroidSLM Downloads</title>
          <style>
            body{font-family:system-ui,Roboto,Inter,Arial;background:#0b0f17;color:#eee;margin:0}
            .wrap{max-width:960px;margin:auto;padding:40px}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;box-shadow:0 8px 40px rgba(0,0,0,0.4);padding:32px;backdrop-filter:blur(14px)}
            a{color:#72d0ff;text-decoration:none}
            footer{margin-top:24px;font-size:.85em;opacity:.7;text-align:center}
            code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
          </style></head>
          <body><div class="wrap"><div class="glass">
          <h1>ğŸ“¦ AndroidSLM â€” Latest Downloads</h1>
          <p><strong>Generated:</strong> ${DATE}</p>
          <h2>â¬‡ï¸ Latest Release</h2>
          <p><a href="${LATEST_APK_URL}">Download APK (<code>${LATEST_APK}</code>)</a></p>
          <p><a href="https://github.com/${REPO}/releases/tag/${LATEST_TAG}">ğŸ”– ${LATEST_TAG}</a> â€¢ <a href="https://github.com/${REPO}/releases">ğŸ“˜ All Releases</a></p>
          <hr><p><strong>QR:</strong></p>
          <p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" alt="QR"></p>
          <footer>Generated by AndroidSLM CI â€” ${DATE}</footer>
          </div></div></body></html>
          HTML

      - name: ğŸš€ Publish GH Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "ğŸŒˆ Update GH Pages + Wiki (${{steps.info.outputs.tag}})"
