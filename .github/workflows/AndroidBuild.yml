# ============================================================
# ğŸš€ AndroidSLM â€” Build + Release + Wiki + Pages (Always Debug Signing)
# ============================================================

name: AndroidSLM â€” Build+Release+Wiki+Pages (Debug-Signed)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      enable_review:
        description: "Run Lint & Unit Tests before build"
        type: boolean
        default: true
      force_build:
        description: "Force rebuild regardless of diff detection"
        type: boolean
        default: false
      version_tag:
        description: "Release tag (empty = auto; tag push = use pushed tag)"
        required: false
        type: string
      prerelease:
        description: "Mark GitHub Release as prerelease"
        required: false
        default: true
        type: boolean
      build_type:
        description: "Variant (auto = release (debug-signed), or debug)"
        required: false
        default: "auto"
        type: choice
        options: [auto, release, debug]

permissions:
  contents: write
  pages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  OWNER: ${{ github.repository_owner }}
  REPO: ${{ github.repository }}       # e.g. ishizuki-tech/AndroidSLM
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_VERSION: "17"
  NDK_VERSION: 28.1.13356709
  _JAVA_OPTIONS: "-Xmx4g"
  GRADLE_OPTS: "-Xmx4g -Dorg.gradle.daemon=true"

# ============================================================
# ğŸ§  detect / build / publish
# ============================================================

jobs:
  detect:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: detect
        run: |
          set -Eeuo pipefail
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED=$(git diff --name-only "$LAST_TAG" HEAD | grep -E '^(app/|nativelib/|gradle/|.*\.(kt|kts|cpp|hpp|h|yaml|yml))' || true)
          if [ -n "$CHANGED" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================
  # ğŸ—ï¸ Build + GitHub Release (Always debug-signed artifacts)
  # ============================================================
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: detect
    if: ${{ needs.detect.outputs.changed == 'true' || inputs.force_build == true || startsWith(github.ref, 'refs/tags/') }}
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      variant: ${{ steps.build.outputs.variant }}
      signing: ${{ steps.build.outputs.signing }}
      apk_name: ${{ steps.alias.outputs.apk_tag_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: gradle

      - name: ğŸ§± Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ› ï¸ Setup Android (sdk/ndk)
        uses: android-actions/setup-android@v3
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: ğŸ“œ Accept SDK Licenses
        run: |
          set -e
          SDKMANAGER="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager"
          if [ -x "$SDKMANAGER" ]; then
            yes | "$SDKMANAGER" --licenses || true
          fi

      - name: ğŸ§ª Lint & Unit tests (optional)
        if: ${{ inputs.enable_review == true || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) }}
        run: |
          ./gradlew lintDebug testDebugUnitTest || echo "::warning::Lint/Tests failed (continuing)"

      - name: ğŸ—ï¸ Build (release/debug, debug keystore assumed)
        id: build
        run: |
          set -e
          VARIANT_INPUT="${{ inputs.build_type }}"
          if [ "$VARIANT_INPUT" = "debug" ]; then
            VARIANT="debug"
          else
            VARIANT="release"
          fi
          echo "Chosen variant: $VARIANT"

          if [ "$VARIANT" = "debug" ]; then
            ./gradlew :app:clean :app:assembleDebug --stacktrace
            APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          else
            ./gradlew :app:clean :app:assembleRelease --stacktrace
            APK_PATH="app/build/outputs/apk/release/app-release.apk"
          fi

          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found at $APK_PATH"
            exit 1
          fi

          echo "variant=$VARIANT" >> "$GITHUB_OUTPUT"
          echo "signing=debug" >> "$GITHUB_OUTPUT"
          echo "apk=$APK_PATH" >> "$GITHUB_OUTPUT"

      - name: ğŸ·ï¸ Derive version tag
        id: tag
        run: |
          set -e
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF##*/}"
          elif [ -n "${{ inputs.version_tag }}" ]; then
            TAG="${{ inputs.version_tag }}"
          else
            VERSION=$(grep -E 'versionName\s*=\s*"([^"]+)"' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/' | head -n1 || echo "0.0.0")
            SHA=$(git rev-parse --short HEAD)
            TAG="v${VERSION}-${SHA}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Release tag: $TAG"

      - name: â™»ï¸ Normalize filenames
        id: alias
        run: |
          set -e
          TAG="${{ steps.tag.outputs.tag }}"
          SRC_APK="${{ steps.build.outputs.apk }}"
          mkdir -p publish

          if [ ! -f "$SRC_APK" ]; then
            echo "âŒ Source APK not found: $SRC_APK"
            exit 1
          fi

          APK_TAG="AndroidSLM-${TAG}.apk"
          APK_LATEST="AndroidSLM-latest.apk"

          cp "$SRC_APK" "publish/${APK_TAG}"
          cp "$SRC_APK" "publish/${APK_LATEST}"

          echo "apk_tag=publish/${APK_TAG}" >> "$GITHUB_OUTPUT"
          echo "apk_latest=publish/${APK_LATEST}" >> "$GITHUB_OUTPUT"
          echo "apk_tag_name=${APK_TAG}" >> "$GITHUB_OUTPUT"

          echo "::group::Normalized APKs"
          ls -lh publish || true
          echo "::endgroup::"

      - name: ğŸ“° Release Notes
        run: |
          {
            echo "## AndroidSLM â€” debug-signed build"
            echo "- Tag: ${{ steps.tag.outputs.tag }}"
            echo "- Variant: ${{ steps.build.outputs.variant }}"
            echo "- Signing: debug"
            echo "- APK (tag): AndroidSLM-${{ steps.tag.outputs.tag }}.apk"
            echo "- APK (latest alias): AndroidSLM-latest.apk"
          } > RELEASE_NOTES.md
          cat RELEASE_NOTES.md

      - name: ğŸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: AndroidSLM ${{ steps.tag.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: |
            ${{ steps.alias.outputs.apk_tag }}
            ${{ steps.alias.outputs.apk_latest }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # ğŸš€ Publish Wiki + GH Pages
  # ============================================================
  publish:
    name: Publish Wiki + Pages
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§® Resolve TAG/DATE/BASE
        id: info
        run: |
          set -e
          TAG="${{ needs.build.outputs.tag }}"
          DATE="$(date '+%Y-%m-%d %H:%M')"
          REPO="${{ env.REPO }}"
          OWNER="${{ env.OWNER }}"
          BASE_URL="https://${OWNER}.github.io/${REPO#*/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "repo=$REPO" >> "$GITHUB_OUTPUT"
          echo "base=$BASE_URL" >> "$GITHUB_OUTPUT"

      - name: ğŸ” Resolve latest build APK (æœ€æ–°Buildã¨ã—ã¦ã®latest)
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${{ steps.info.outputs.repo }}"

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "::warning::GH_TOKEN not set; fallback to Releases page."
            echo "latest_tag=" >> "$GITHUB_OUTPUT"
            echo "latest_apk_name=" >> "$GITHUB_OUTPUT"
            echo "latest_apk_url=https://github.com/${REPO}/releases" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y >/dev/null
            sudo apt-get install -y jq >/dev/null
          fi

          curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases?per_page=10" \
            -o releases.json

          # æœ€æ–°ã®édraftãƒªãƒªãƒ¼ã‚¹ = æœ€æ–°Build
          LATEST_TAG="$(jq -r '[.[] | select(.draft==false)][0].tag_name // empty' releases.json)"
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "::warning::No non-draft releases; fallback."
            echo "latest_tag=" >> "$GITHUB_OUTPUT"
            echo "latest_apk_name=" >> "$GITHUB_OUTPUT"
            echo "latest_apk_url=https://github.com/${REPO}/releases" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          APK_NAME="$(
            jq -r --arg TAG "$LATEST_TAG" '
              (.[] | select(.draft==false and .tag_name==$TAG) | .assets[]?.name) // empty
            ' releases.json \
            | grep -E '\.apk$' \
            | head -n1 || true
          )"

          if [ -n "$APK_NAME" ]; then
            APK_URL="https://github.com/${REPO}/releases/download/${LATEST_TAG}/${APK_NAME}"
          else
            APK_URL="https://github.com/${REPO}/releases/tag/${LATEST_TAG}"
          fi

          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "latest_apk_name=$APK_NAME" >> "$GITHUB_OUTPUT"
          echo "latest_apk_url=$APK_URL" >> "$GITHUB_OUTPUT"

          echo "::group::Latest build asset"
          echo "LATEST_TAG : $LATEST_TAG"
          echo "APK_NAME   : ${APK_NAME:-'(none)'}"
          echo "APK_URL    : $APK_URL"
          echo "::endgroup::"

      - name: ğŸ“ Update Wiki (Home + <TAG>.md)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ steps.info.outputs.tag }}"
          DATE="${{ steps.info.outputs.date }}"
          REPO="${{ steps.info.outputs.repo }}"
          BASE_URL="${{ steps.info.outputs.base }}"
          LATEST_APK_URL="${{ steps.latest.outputs.latest_apk_url }}"

          mkdir -p wiki

          # å€‹åˆ¥ Build ãƒšãƒ¼ã‚¸
          {
            echo "# ğŸ“¦ AndroidSLM â€” Build ${TAG}"
            echo "Generated: ${DATE}"
            echo ""
            echo "## â¬‡ï¸ Download"
            if [ -n "$LATEST_APK_URL" ]; then
              echo "- [Latest Build APK](${LATEST_APK_URL})"
            else
              echo "- [Latest Build APK](https://github.com/${REPO}/releases)"
            fi
            echo "- [This tag APK](https://github.com/${REPO}/releases/download/${TAG}/AndroidSLM-${TAG}.apk)"
            echo "- [All Releases](https://github.com/${REPO}/releases)"
          } > "wiki/${TAG}.md"

          # Home.md å†ç”Ÿæˆ
          {
            echo "# ğŸ  AndroidSLM Wiki Home"
            echo "Updated: ${DATE}"
            echo ""
            echo "## ğŸ“œ Build History (latest 20)"
          } > wiki/Home.md

          MAP_TMP="wiki/_link-map.txt"
          : > "$MAP_TMP"

          LIST=$(find wiki -maxdepth 1 -type f -name '*.md' ! -name 'Home.md' | sort -r | head -n 20 || true)
          if [ -z "$LIST" ]; then
            echo "_No builds yet._" >> wiki/Home.md
          else
            echo "$LIST" | while read -r f; do
              base="$(basename "$f" .md)"
              slug="$(printf '%s' "$base" | sed -E 's@[[:space:]]+@-@g; s@/@-@g; s/-+/-/g')"
              printf -- "- [%s](https://github.com/%s/wiki/%s)\n" "$base" "$REPO" "$slug" >> wiki/Home.md
              printf -- "%s.md -> %s\n" "$base.md" "$slug" >> "$MAP_TMP"
            done
          fi

          {
            echo ""
            echo "## ğŸŒ GH Pages"
            echo "- [Downloads Page](${BASE_URL})"
          } >> wiki/Home.md

          echo "::group::Wiki tree"
          ls -R wiki || true
          echo "::endgroup::"
          echo "::group::Wiki link map"
          cat "$MAP_TMP" || true
          echo "::endgroup::"

          # .wiki ãƒªãƒã‚¸ãƒˆãƒªã¸ pushï¼ˆWiki æœ‰åŠ¹ãŒå‰æï¼‰
          if [ -n "${GH_TOKEN:-}" ]; then
            cd wiki
            git init
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add .
            git commit -m "Update Wiki ${TAG}" || git commit --allow-empty -m "Ensure wiki"
            git branch -M master
            git remote add origin "https://${{ github.actor }}:${GH_TOKEN}@github.com/${REPO}.wiki.git"
            git push origin master --force || echo "::warning::Failed to push wiki (is Wiki enabled?)"
          else
            echo "::warning::GH_TOKEN not set; skip wiki push."
          fi

      - name: ğŸ’ Generate GH Pages (Glass UI)
        run: |
          set -euo pipefail
          TAG_THIS="${{ steps.info.outputs.tag }}"
          DATE="${{ steps.info.outputs.date }}"
          REPO="${{ steps.info.outputs.repo }}"
          BASE_URL="${{ steps.info.outputs.base }}"
          LATEST_TAG="${{ steps.latest.outputs.latest_tag }}"
          LATEST_APK_URL="${{ steps.latest.outputs.latest_apk_url }}"

          if [ -z "$LATEST_APK_URL" ]; then
            LATEST_APK_URL="https://github.com/${REPO}/releases"
          fi

          mkdir -p gh-pages

          cat > gh-pages/index.html <<HTML
          <!doctype html><html lang="en"><head>
          <meta charset="utf-8"/>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>ğŸ“¦ AndroidSLM Downloads</title>
          <style>
            body{font-family:system-ui,Roboto,Inter,Arial;background:#0b0f17;color:#eee;margin:0}
            .wrap{max-width:960px;margin:auto;padding:40px}
            .glass{background:rgba(255,255,255,0.08);border-radius:20px;
                   box-shadow:0 8px 40px rgba(0,0,0,0.4);
                   padding:32px;backdrop-filter:blur(14px)}
            a{color:#72d0ff;text-decoration:none}
            footer{margin-top:24px;font-size:.85em;opacity:.7;text-align:center}
            code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
            .muted{opacity:.8}
          </style>
          </head>
          <body><div class="wrap"><div class="glass">
          <h1>ğŸ“¦ AndroidSLM â€” Latest Downloads</h1>
          <p class="muted"><strong>Generated:</strong> ${DATE}</p>

          <h2>â¬‡ï¸ Latest Build</h2>
          <p><a href="${LATEST_APK_URL}">Download Latest APK</a></p>
          <p>
            ${LATEST_TAG:+<a href="https://github.com/${REPO}/releases/tag/${LATEST_TAG}">ğŸ”– ${LATEST_TAG}</a> â€¢ }
            <a href="https://github.com/${REPO}/releases">ğŸ“˜ All Releases</a>
          </p>

          <hr style="border-color:rgba(255,255,255,.15);margin:24px 0">

          <h2>âš™ï¸ Configuration</h2>
          <p>
            <a href="https://github.com/ishizuki-tech/AndroidSLM/blob/main/app/src/main/assets/slm_config.yaml">
              View <code>slm_config.yaml</code> on GitHub
            </a>
          </p>

          <p style="margin-top:16px;">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${BASE_URL}" alt="QR">
          </p>
          <footer>Generated by AndroidSLM CI â€” ${DATE}</footer>
          </div></div></body></html>
          HTML

          echo "::group::gh-pages tree"
          ls -R gh-pages || true
          echo "::endgroup::"

      - name: ğŸš€ Publish GH Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "ğŸŒˆ Update GH Pages + Wiki (${{ steps.info.outputs.tag }})"
